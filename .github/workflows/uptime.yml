name: Uptime & Health Monitoring

on:
  schedule:
    - cron: "*/5 * * * *"      # Health checks every 5 minutes
    - cron: "55 23 * * *"      # Daily summary at 23:55 UTC
  workflow_dispatch:

jobs:
  health:
    name: Health Check
    runs-on: ubuntu-latest
    if: github.event.schedule != '55 23 * * *' || github.event_name == 'workflow_dispatch'

    env:
      BACKEND_HEALTH_URL: ${{ secrets.BACKEND_HEALTH_URL }}
      FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      ALERT_EMAIL_TO: ${{ secrets.ALERT_EMAIL_TO }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: npm

      - name: Install dependencies
        run: npm ci --omit=dev || true

      - name: Run healthcheck
        id: healthcheck
        run: node scripts/healthcheck.mjs
        continue-on-error: true

      - name: Commit logs
        run: |
          git config user.name "uptime-bot"
          git config user.email "actions@github.com"
          git add ops/uptime || true
          git commit -m "chore(uptime): health check logs [skip ci]" || echo "nothing to commit"
          git push || echo "no push (PR context or no changes)"

      - name: Upload report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: uptime-report-${{ github.run_id }}
          path: ops/uptime/latest/report.json
          if-no-files-found: warn

      - name: Send alert on failure
        if: failure() && steps.healthcheck.outcome == 'failure'
        run: node scripts/alert.mjs "health-check-failure" "ProductifyAI health check failed"

  daily:
    name: Daily Summary
    runs-on: ubuntu-latest
    if: github.event.schedule == '55 23 * * *' || github.event_name == 'workflow_dispatch'

    env:
      BACKEND_HEALTH_URL: ${{ secrets.BACKEND_HEALTH_URL }}
      FRONTEND_URL: ${{ secrets.FRONTEND_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: npm

      - name: Install dependencies
        run: npm ci --omit=dev || true

      - name: Generate daily summary
        run: node scripts/daily-summary.mjs

      - name: Commit daily report
        run: |
          git config user.name "uptime-bot"
          git config user.email "actions@github.com"
          git add ops/uptime/REPORTS || true
          git commit -m "chore(uptime): daily summary report [skip ci]" || echo "nothing to commit"
          git push || echo "no push (PR context or no changes)"

      - name: Upload daily report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-report-${{ github.run_id }}
          path: ops/uptime/REPORTS/*.md
          if-no-files-found: warn

