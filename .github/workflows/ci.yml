name: CI/CD Pipeline

on:
  push:
    branches: [main, replit-agent]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [22.x]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
      
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Type check (fails build on errors)
        run: pnpm run check
      
      - name: Lint (if script exists)
        run: pnpm run lint || echo "âš ï¸  No lint script found, skipping"
        continue-on-error: true
      
      - name: Build (Frontend + Backend)
        run: pnpm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_API_URL: https://productifyai-api.onrender.com
      
      - name: Verify build outputs
        run: |
          echo "ðŸ“¦ Checking build outputs..."
          if [ ! -f "dist/server.js" ]; then
            echo "âŒ Backend build failed: dist/server.js not found"
            exit 1
          fi
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Frontend build failed: dist/index.html not found"
            exit 1
          fi
          echo "âœ… Backend built: dist/server.js"
          echo "âœ… Frontend built: dist/index.html"
          ls -lah dist/
      
      - name: Run tests
        run: pnpm run test:ci || echo "âš ï¸  No tests configured yet, skipping"
        continue-on-error: true
      
      - name: Robust secrets scan
        run: |
          echo "ðŸ” Scanning build output for leaked secrets..."
          SCAN_FAILED=0
          
          # 1. Check for OpenAI API keys (sk-test-, sk-live-, sk-proj-)
          echo "Checking for OpenAI API keys..."
          if grep -rE "sk-(test|live|proj)-[A-Za-z0-9]{20,}" dist/ 2>/dev/null; then
            echo "âŒ CRITICAL: OpenAI API key found in build output!"
            SCAN_FAILED=1
          else
            echo "âœ… No OpenAI keys found"
          fi
          
          # 2. Check for Stripe secret keys
          echo "Checking for Stripe secret keys..."
          if grep -rE "sk_(test|live)_[A-Za-z0-9]{24,}" dist/ 2>/dev/null; then
            echo "âŒ CRITICAL: Stripe secret key found in build output!"
            SCAN_FAILED=1
          else
            echo "âœ… No Stripe secret keys found"
          fi
          
          # 3. Check for generic private keys
          echo "Checking for private keys..."
          if grep -r "BEGIN PRIVATE KEY" dist/ 2>/dev/null; then
            echo "âŒ CRITICAL: Private key found in build output!"
            SCAN_FAILED=1
          else
            echo "âœ… No private keys found"
          fi
          
          # 4. Check for long base64 tokens (excluding known public Supabase anon key)
          echo "Checking for suspicious JWT-like tokens..."
          # Extract the known Supabase anon key from environment
          KNOWN_ANON_KEY="${{ secrets.VITE_SUPABASE_ANON_KEY }}"
          
          # Search for JWT-like patterns
          if grep -rE "eyJ[A-Za-z0-9_-]{20,}\.[A-Za-z0-9_-]{20,}\.[A-Za-z0-9_-]{20,}" dist/ 2>/dev/null > /tmp/jwt_matches.txt; then
            # Filter out the known anon key
            if [ -n "$KNOWN_ANON_KEY" ]; then
              grep -v "$KNOWN_ANON_KEY" /tmp/jwt_matches.txt > /tmp/jwt_suspicious.txt || true
              if [ -s /tmp/jwt_suspicious.txt ]; then
                echo "âš ï¸  WARNING: Found JWT-like tokens (not the known anon key):"
                cat /tmp/jwt_suspicious.txt
                echo "If these are public keys, this is OK. If private keys, this is CRITICAL."
              else
                echo "âœ… Only known public Supabase anon key found (OK)"
              fi
            fi
          else
            echo "âœ… No JWT-like tokens found"
          fi
          
          if [ $SCAN_FAILED -eq 1 ]; then
            echo ""
            echo "âŒâŒâŒ SECRET LEAK DETECTED âŒâŒâŒ"
            echo "Build output contains sensitive credentials!"
            echo "Review the files listed above and remove secrets."
            exit 1
          fi
          
          echo ""
          echo "âœ… Secrets scan passed - no critical leaks detected"
      
      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist/
            client/dist/
          retention-days: 7
      
      - name: Build summary
        run: |
          echo "### âœ… Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Node: ${{ matrix.node-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Status: Success" >> $GITHUB_STEP_SUMMARY

